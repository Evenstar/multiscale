%%
img=double(imread('../data/barbara.png'))/255;
opt.filter{1}=randn(7,7,1,6)/12;
opt.filter{2}=randn(7,7,6,18)/12;
opt.filter{3}=randn(7,7,18,24)/24;
opt.filter{4}=randn(7,7,24,12)/24;
opt.filter{5}=randn(7,7,12,6)/12;
%%
opt.lambda=[1e-4,1e-5,1e-5,1e-5,1e-5]*100;
opt.outer_iter=[10,10,10,10,10]*2;
opt.cg_iter=[2 2 2,2,2]*5;
opt.fista_iter=[1,1,1,1,1]*5;
opt.shape{1}=[2,2];
opt.shape{2}=[2,2];
opt.shape{3}=[2,2];
opt.shape{4}=[2,2];
opt.shape{5}=[2,2];
opt.L=[100,200,200,200,200];
[recx,newopt]=learn_multiple_layers(img,opt,5);
opt=newopt;

%%
opt.fista_iter=[50,50,50,50,50]*2;
[recx,v,p,s]=infer_multiple_layers(img,opt,5);
%%
u=zeros(size(v));
u=v.*(abs(v)>6);
x=inter_backward(u,opt.p,opt.s,opt.filter,5);
imdisp(x)
%%
opt.fista_iter=[50,50,50,50,50];
[recx2,v2,p2,s2]=infer_multiple_layers(img,opt,2);